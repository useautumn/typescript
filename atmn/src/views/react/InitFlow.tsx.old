import { Box, Text, useApp } from "ink";
import open from "open";
import React, { useCallback, useEffect, useState, useRef } from "react";
import { FRONTEND_URL } from "../../../source/constants.js";
import { externalRequest } from "../../../source/core/api.js";
import { getOrgMe } from "../../../source/core/requests/orgRequests.js";
import { readFromEnv, storeToEnv } from "../../../source/core/utils.js";
import { CLI_CLIENT_ID } from "../../commands/auth/constants.js";
import {
	getApiKeysWithToken,
	startOAuthFlow,
} from "../../commands/auth/oauth.js";
import { StatusLine } from "./components/StatusLine.js";
import { StepHeader } from "./components/StepHeader.js";

const TOTAL_STEPS = 5;

interface OrgInfo {
	name: string;
	slug: string;
	env: string;
	email?: string;
	stripe_connection?: string;
}

type AuthState =
	| "checking"
	| "not_authenticated"
	| "authenticating"
	| "authenticated"
	| "error";
type StripeState =
	| "pending"
	| "checking"
	| "not_connected"
	| "connecting"
	| "connected"
	| "error";

export function InitFlow() {
	const { exit } = useApp();
	
	// Step 1: Auth
	const [authState, setAuthState] = useState<AuthState>("checking");
	const [orgInfo, setOrgInfo] = useState<OrgInfo | null>(null);
	const [authError, setAuthError] = useState<string | null>(null);
	
	// Step 2: Stripe
	const [stripeState, setStripeState] = useState<StripeState>("pending");
	const [stripeError, setStripeError] = useState<string | null>(null);
	const pollIntervalRef = useRef<NodeJS.Timeout | null>(null);

	const startAuth = useCallback(async () => {
		setAuthState("authenticating");

		try {
			const { tokens } = await startOAuthFlow(CLI_CLIENT_ID);
			const { sandboxKey, prodKey } = await getApiKeysWithToken(
				tokens.access_token,
			);

			await storeToEnv(prodKey, sandboxKey);

			// Fetch org info with new key
			const info = await getOrgMe();
			setOrgInfo(info);
			setAuthState("authenticated");
		} catch (error) {
			setAuthError(
				error instanceof Error ? error.message : "Authentication failed",
			);
			setAuthState("error");
		}
	}, []);

	const connectStripe = useCallback(async () => {
		setStripeState("connecting");
		
		// Open dashboard to Stripe connect page
		const stripeConnectUrl = `${FRONTEND_URL}/dev?tab=stripe`;
		await open(stripeConnectUrl);
		
		// Poll for Stripe connection
		const maxAttempts = 60; // 5 minutes with 5 second intervals
		let attempts = 0;
		
		const pollInterval = setInterval(async () => {
			attempts++;
			
			try {
				const orgDetails = (await externalRequest({
					method: "GET",
					path: "/organization",
					throwOnError: true,
				})) as { stripe_connection?: string };
				
				if (orgDetails.stripe_connection && orgDetails.stripe_connection !== "none") {
					if (pollIntervalRef.current) {
						clearInterval(pollIntervalRef.current);
						pollIntervalRef.current = null;
					}
					setStripeState("connected");
				} else if (attempts >= maxAttempts) {
					if (pollIntervalRef.current) {
						clearInterval(pollIntervalRef.current);
						pollIntervalRef.current = null;
					}
					setStripeError("Timed out waiting for Stripe connection");
					setStripeState("error");
				}
			} catch {
				// Continue polling on error
			}
		}, 5000);
		
		pollIntervalRef.current = pollInterval;
	}, []);

	const checkStripe = useCallback(async () => {
		setStripeState("checking");

		try {
			// Fetch org details to check Stripe connection
			const orgDetails = (await externalRequest({
				method: "GET",
				path: "/organization",
				throwOnError: true,
			})) as { stripe_connection?: string };
			
			if (orgDetails.stripe_connection && orgDetails.stripe_connection !== "none") {
				setStripeState("connected");
			} else {
				setStripeState("not_connected");
				// Auto-open Stripe connect page
				await connectStripe();
			}
		} catch (error) {
			setStripeError(
				error instanceof Error
					? error.message
					: "Failed to check Stripe status",
			);
			setStripeState("error");
		}
	}, [connectStripe]);

	const checkAuth = useCallback(async () => {
		setAuthState("checking");

		try {
			const apiKey = readFromEnv({ bypass: true });

			if (!apiKey) {
				setAuthState("not_authenticated");
				// Auto-start OAuth flow
				await startAuth();
				return;
			}

			// Verify the key works by fetching org info
			const info = await getOrgMe();
			setOrgInfo(info);
			setAuthState("authenticated");
		} catch {
			// Key exists but is invalid
			setAuthState("not_authenticated");
			await startAuth();
		}
	}, [startAuth]);

	// Step 1: Check authentication on mount
	useEffect(() => {
		checkAuth();
	}, [checkAuth]);

	// Step 2: Check Stripe when auth completes
	useEffect(() => {
		if (authState === "authenticated" && orgInfo) {
			checkStripe();
		}
	}, [authState, orgInfo, checkStripe]);

	// Cleanup: clear poll interval on unmount
	useEffect(() => {
		return () => {
			if (pollIntervalRef.current) {
				clearInterval(pollIntervalRef.current);
				pollIntervalRef.current = null;
			}
		};
	}, []);

	return (
		<Box flexDirection="column" padding={1}>
			{/* Welcome message */}
			<Box marginBottom={1}>
				<Text>
					Welcome to{" "}
					<Text color="cyan" bold>
						Autumn
					</Text>
					! Let's set up your billing.
				</Text>
			</Box>

			{/* Step 1: Authentication */}
			<Box flexDirection="column" marginBottom={1}>
				<StepHeader step={1} totalSteps={TOTAL_STEPS} title="Authentication" />

				{authState === "checking" && (
					<StatusLine status="loading" message="Checking authentication..." />
				)}

				{authState === "not_authenticated" && (
					<StatusLine status="loading" message="Opening browser for login..." />
				)}

				{authState === "authenticating" && (
					<StatusLine
						status="loading"
						message="Waiting for authentication..."
					/>
				)}

				{authState === "authenticated" && orgInfo && (
					<StatusLine
						status="success"
						message={`Logged in as ${orgInfo.name}`}
						detail={orgInfo.slug}
					/>
				)}

				{authState === "error" && (
					<StatusLine
						status="error"
						message={authError || "Authentication failed"}
					/>
				)}
			</Box>

			{/* Step 2: Stripe Connection (only show after auth) */}
			{authState === "authenticated" && (
				<Box flexDirection="column" marginBottom={1}>
					<StepHeader
						step={2}
						totalSteps={TOTAL_STEPS}
						title="Stripe Connection"
					/>

					{stripeState === "checking" && (
						<StatusLine
							status="loading"
							message="Checking Stripe connection..."
						/>
					)}

					{stripeState === "not_connected" && (
						<StatusLine status="loading" message="Opening Stripe Connect..." />
					)}

					{stripeState === "connecting" && (
						<Box flexDirection="column">
							<StatusLine
								status="loading"
								message="Waiting for Stripe connection..."
							/>
							<Text dimColor>
								{" "}
								Complete the setup in your browser, then return here.
							</Text>
						</Box>
					)}

					{stripeState === "connected" && (
						<StatusLine status="success" message="Stripe connected" />
					)}

					{stripeState === "error" && (
						<StatusLine
							status="error"
							message={stripeError || "Stripe connection failed"}
						/>
					)}
				</Box>
			)}

			{/* Exit on error */}
			{(authState === "error" || stripeState === "error") && (
				<Box marginTop={1}>
					<Text dimColor>Press Ctrl+C to exit and try again.</Text>
				</Box>
			)}
		</Box>
	);
}
